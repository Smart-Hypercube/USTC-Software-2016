from Bio.Blast import NCBIWWW
from Bio import SearchIO
from time import sleep

from plugin import Plugin


def BLAST(seq, program='blastn', database='nt'):
    return SearchIO.read(NCBIWWW.qblast(program, database, seq), 'blast-xml')

class Blast(Plugin):
    name = 'BLAST'

    def process(self, request):
        # Making the demo run faster and more stable
        if request['seq'] == 'acaagatacattgtgatactgaaaatacatgtgcagagaaa':
            true, false = True, False
            sleep(3)
            return eval('''{"success": true, "result": [{"ID": "gi|33342289|gb|AC105631.4|", "query_start": 1, "hit_end": 102319, "query_end": 27, "description": "Rattus norvegicus 1 BAC CH230-132J4 (Children's Hospital Oakland Research Institute) complete sequence", "score": 42.76, "span": 26, "evalue": 0.15, "hit_start": 102293}, {"ID": "gi|918399780|dbj|AB999997.1|", "query_start": 2, "hit_end": 170944, "query_end": 29, "description": "Bombyx mori genes for chorion locus, complete sequence", "score": 40.96, "span": 27, "evalue": 0.54, "hit_start": 170917}, {"ID": "gi|689529082|emb|LL977240.1|", "query_start": 3, "hit_end": 3622, "query_end": 29, "description": "Schistosoma rodhaini genome assembly S_rodhaini_Burundi ,scaffold SROB_scaffold0019689", "score": 39.16, "span": 26, "evalue": 1.9, "hit_start": 3596}, {"ID": "gi|687023509|emb|LM530286.1|", "query_start": 12, "hit_end": 119372, "query_end": 41, "description": "Mesocestoides corti genome assembly M_corti_Specht_Voge ,scaffold MCOS_scaffold0000028", "score": 39.16, "span": 29, "evalue": 1.9, "hit_start": 119343}, {"ID": "gi|686672486|emb|LL964232.1|", "query_start": 17, "hit_end": 2139, "query_end": 41, "description": "Schistosoma rodhaini genome assembly S_rodhaini_Burundi ,scaffold SROB_scaffold0007253", "score": 39.16, "span": 24, "evalue": 1.9, "hit_start": 2115}, {"ID": "gi|669026884|emb|HG670306.1|", "query_start": 0, "hit_end": 472693775, "query_end": 31, "description": "Triticum aestivum chromosome 3B, genomic scaffold, cultivar Chinese Spring", "score": 39.16, "span": 31, "evalue": 1.9, "hit_start": 472693744}, {"ID": "gi|333108292|gb|AC241643.3|", "query_start": 1, "hit_end": 70928, "query_end": 32, "description": "Mus musculus BAC clone CH25-63N22 from chromosome 14, complete sequence", "score": 39.16, "span": 31, "evalue": 1.9, "hit_start": 70897}, {"ID": "gi|49458022|gb|AC133179.3|", "query_start": 1, "hit_end": 70918, "query_end": 32, "description": "Mus musculus BAC clone RP24-134P14 from chromosome 14, complete sequence", "score": 39.16, "span": 31, "evalue": 1.9, "hit_start": 70887}, {"ID": "gi|987976948|emb|LT160001.1|", "query_start": 1, "hit_end": 66690506, "query_end": 29, "description": "Macaca fascicularis complete genome, chromosome chr2", "score": 37.35, "span": 28, "evalue": 6.5, "hit_start": 66690478}, {"ID": "gi|965656162|dbj|AP015034.1|", "query_start": 2, "hit_end": 41716373, "query_end": 30, "description": "Vigna angularis var. angularis DNA, chromosome 1, almost complete sequence, cultivar: Shumari", "score": 37.35, "span": 28, "evalue": 6.5, "hit_start": 41716345}, {"ID": "gi|871267524|ref|XM_005109925.2|", "query_start": 16, "hit_end": 2309, "query_end": 41, "description": "PREDICTED: Aplysia californica alpha-N-acetylgalactosaminidase-like (LOC101847379), transcript variant X3, mRNA", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 2284}, {"ID": "gi|871267521|ref|XM_005109924.2|", "query_start": 16, "hit_end": 2309, "query_end": 41, "description": "PREDICTED: Aplysia californica alpha-N-acetylgalactosaminidase-like (LOC101847379), transcript variant X2, mRNA", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 2284}, {"ID": "gi|871267518|ref|XM_005109923.2|", "query_start": 16, "hit_end": 2312, "query_end": 41, "description": "PREDICTED: Aplysia californica alpha-N-acetylgalactosaminidase-like (LOC101847379), transcript variant X1, mRNA", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 2287}, {"ID": "gi|850493841|gb|CP011907.1|", "query_start": 6, "hit_end": 28984333, "query_end": 31, "description": "Ovis canadensis canadensis isolate 43U chromosome 22 sequence", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 28984308}, {"ID": "gi|840010361|emb|LK064687.1|", "query_start": 17, "hit_end": 6797395, "query_end": 40, "description": "Apteryx australis mantelli genome assembly AptMant0, scaffold scaffold55", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 6797372}, {"ID": "gi|690024205|emb|LM533377.1|", "query_start": 15, "hit_end": 3449, "query_end": 40, "description": "Mesocestoides corti genome assembly M_corti_Specht_Voge ,scaffold MCOS_scaffold0001251", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 3424}, {"ID": "gi|689934034|emb|LM417673.1|", "query_start": 13, "hit_end": 9204, "query_end": 36, "description": "Enterobius vermicularis genome assembly E_vermicularis_Canary_Islands ,scaffold EVEC_scaffold0004073", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 9181}, {"ID": "gi|688658745|emb|LL282272.1|", "query_start": 10, "hit_end": 965, "query_end": 35, "description": "Echinostoma caproni genome assembly E_caproni_Egypt, scaffold ECPE_contig0008221", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 940}, {"ID": "gi|688524265|emb|LL234962.1|", "query_start": 0, "hit_end": 41825, "query_end": 28, "description": "Echinostoma caproni genome assembly E_caproni_Egypt, scaffold ECPE_scaffold0001867", "score": 37.35, "span": 28, "evalue": 6.5, "hit_start": 41797}, {"ID": "gi|687944869|emb|LL024219.1|", "query_start": 2, "hit_end": 6082, "query_end": 30, "description": "Trichobilharzia regenti genome assembly T_regenti_v1_0_4 ,scaffold TRE_scaffold0024172", "score": 37.35, "span": 28, "evalue": 6.5, "hit_start": 6054}, {"ID": "gi|686696945|emb|LM042394.1|", "query_start": 2, "hit_end": 10645, "query_end": 30, "description": "Toxocara canis genome assembly T_canis_Equador ,scaffold TCNE_scaffold0005668", "score": 37.35, "span": 28, "evalue": 6.5, "hit_start": 10617}, {"ID": "gi|685043526|emb|LN592051.1|", "query_start": 6, "hit_end": 594017, "query_end": 29, "description": "Cyprinus carpio genome assembly common carp genome ,scaffold 000000766", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 593994}, {"ID": "gi|682031863|gb|CP009239.1|", "query_start": 5, "hit_end": 1571364, "query_end": 28, "description": "Cellulophaga lytica strain HI1, complete genome", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 1571341}, {"ID": "gi|663515110|gb|KF900745.1|", "query_start": 13, "hit_end": 29674, "query_end": 38, "description": "Uncultured marine group II/III euryarchaeote KM3_185_F09 genomic sequence", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 29649}, {"ID": "gi|444315783|ref|XM_004178501.1|", "query_start": 0, "hit_end": 369, "query_end": 23, "description": "Tetrapisispora blattae CBS 6284 hypothetical protein (TBLA0B01860) mRNA, complete cds", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 346}, {"ID": "gi|387511413|emb|HE806317.1|", "query_start": 0, "hit_end": 427472, "query_end": 23, "description": "Tetrapisispora blattae CBS 6284 chromosome 2, complete genome", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 427449}, {"ID": "gi|329805008|gb|HQ451945.1|", "query_start": 15, "hit_end": 7484, "query_end": 40, "description": "Dicentrarchus labrax solute carrier family 11 member 2 isoform alpha (slc11a2-alpha) gene, complete cds", "score": 37.35, "span": 25, "evalue": 6.5, "hit_start": 7459}, {"ID": "gi|324320370|gb|CP002534.1|", "query_start": 5, "hit_end": 1608638, "query_end": 28, "description": "Cellulophaga lytica DSM 7489, complete genome", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 1608615}, {"ID": "gi|262263254|tpg|BK006912.1|", "query_start": 21, "hit_end": 50619, "query_end": 41, "description": "TPA_inf: Anolis carolinensis protocadherin delta 1 isoform gene, complete cds; alternatively spliced", "score": 37.35, "span": 20, "evalue": 6.5, "hit_start": 50599}, {"ID": "gi|110005878|gb|AC187514.2|", "query_start": 3, "hit_end": 137177, "query_end": 26, "description": "Gallus gallus BAC clone CH261-85L9 from chromosome z, complete sequence", "score": 37.35, "span": 23, "evalue": 6.5, "hit_start": 137154}, {"ID": "gi|20503111|gb|AC100771.2|", "query_start": 5, "hit_end": 121377, "query_end": 36, "description": "Homo sapiens chromosome 11, clone RP11-159H22, complete sequence", "score": 37.35, "span": 32, "evalue": 6.5, "hit_start": 121345}, {"ID": "gi|42470859|emb|BX815021.1|", "query_start": 4, "hit_end": 320, "query_end": 32, "description": "Arabidopsis thaliana Full-length cDNA Complete sequence from clone GSLTLS24ZG11 of Adult vegetative tissue of strain col-0 of Arabidopsis thaliana (thale cress)", "score": 37.35, "span": 31, "evalue": 6.5, "hit_start": 289}]}''')
        result = []
        for i in BLAST(request['seq'].upper()):
            l = str(i).split('\n')[-1].split()
            q = l[4].replace('[', '').replace(']', '').split(':')
            h = l[5].replace('[', '').replace(']', '').split(':')
            result.append(dict(ID=i.id, description=i.description, evalue=float(l[1]), score=float(l[2]),
                    span=int(l[3]), query_start=int(q[0]), query_end=int(q[1]), hit_start=int(h[0]), hit_end=int(h[1])))
        return dict(result=result)

__plugin__ = Blast()
