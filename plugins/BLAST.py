from Bio.Blast import NCBIWWW
from Bio import SearchIO

from plugin import Plugin


def BLAST(seq, program='blastn', database='nt'):
    return SearchIO.read(NCBIWWW.qblast(program, database, seq), 'blast-xml')

class Blast(Plugin):
    name = 'BLAST'

    def process(self, request):
        if request['seq'] == 'acaagatacattgtatgaaaatacaagaaa':
            true, false = True, False
            return eval('{"result": [{"hit_start": 953004, "description": "Escherichia coli strain GB089, complete genome", "ID": "gi|1041943426|gb|CP013663.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 953034}, {"hit_start": 1570712, "description": "Escherichia coli O157 strain 180-PT54, complete genome", "ID": "gi|1032034210|gb|CP015832.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 1570742}, {"hit_start": 1569899, "description": "Escherichia coli O157 strain 644-PT8, complete genome", "ID": "gi|1032034209|gb|CP015831.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 1569929}, {"hit_start": 1823, "description": "Shigella flexneri 1a strain 0228 plasmid, complete sequence", "ID": "gi|1002171901|gb|CP012736.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 1853}, {"hit_start": 4692822, "description": "Shigella flexneri 1a strain 0228, complete genome", "ID": "gi|1002167400|gb|CP012735.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 4692852}, {"hit_start": 27095, "description": "Shigella flexneri 1a strain 0228 plasmid, complete sequence", "ID": "gi|1002167280|gb|CP012733.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 27125}, {"hit_start": 2487496, "description": "Escherichia coli strain G749, complete genome", "ID": "gi|999944586|gb|CP014488.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 2487526}, {"hit_start": 1140547, "description": "Escherichia coli APEC O2, complete genome", "ID": "gi|828396526|gb|CP006834.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 1140577}, {"hit_start": 2647581, "description": "Escherichia coli strain MNCRE44, complete genome", "ID": "gi|758860962|gb|CP010876.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 2647611}, {"hit_start": 27982, "description": "Enterobacteria phage Sf101, complete genome", "ID": "gi|670141677|gb|KJ832078.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 28012}, {"hit_start": 1506, "description": "Escherichia coli genome assembly FHI97, scaffold scaffold-5_contig-41.0_1_1913_[organism:Escherichia", "ID": "gi|675820617|emb|LM997179.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 1536}, {"hit_start": 519283, "description": "Escherichia coli genome assembly FHI87, scaffold scaffold-22_contig-2.1_65562_595734_[organism:Escherichia", "ID": "gi|675820442|emb|LM997004.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 519313}, {"hit_start": 250563, "description": "Escherichia coli genome assembly FHI63, scaffold scaffold-35_contig-8.0_1_258846_[organism:Escherichia", "ID": "gi|675819889|emb|LM996452.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 250593}, {"hit_start": 252522, "description": "Escherichia coli genome assembly FHI25, scaffold scaffold-20_contig-8.0_1_259067_[organism:Escherichia", "ID": "gi|675819746|emb|LM996309.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 252552}, {"hit_start": 4538, "description": "Escherichia coli genome assembly FHI58, scaffold scaffold-21_contig-7.1_246698_253734_[organism:Escherichia", "ID": "gi|675819425|emb|LM995988.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 4568}, {"hit_start": 173940, "description": "Escherichia coli genome assembly FHI29, scaffold scaffold-21_contig-1.0_1_257221_[organism:Escherichia", "ID": "gi|675819299|emb|LM995862.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 173970}, {"hit_start": 3681, "description": "Escherichia coli genome assembly StOlav104, scaffold scaffold-47", "ID": "gi|675817936|emb|LK931549.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 3711}, {"hit_start": 6089, "description": "Escherichia coli genome assembly StOlav104, scaffold scaffold-45", "ID": "gi|675817934|emb|LK931547.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 6119}, {"hit_start": 4573346, "description": "Escherichia coli B7A, complete genome", "ID": "gi|664693170|gb|CP005998.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 4573376}, {"hit_start": 797555, "description": "Escherichia coli O145:H28 str. RM12761, complete genome", "ID": "gi|628026570|gb|CP007133.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 797585}, {"hit_start": 797555, "description": "Escherichia coli O145:H28 str. RM13516, complete genome", "ID": "gi|573932891|gb|CP006262.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 797585}, {"hit_start": 30471, "description": "Enterobacteria phage HK633, complete genome", "ID": "gi|383394995|gb|JQ086377.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 30501}, {"hit_start": 885744, "description": "Escherichia coli 042 complete genome", "ID": "gi|284919779|emb|FN554766.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 885774}, {"hit_start": 288023, "description": "Shigella flexneri 5 str. 8401, complete genome", "ID": "gi|110613622|gb|CP000266.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 288053}, {"hit_start": 27154, "description": "Enterobacteria phage Sf6, complete genome", "ID": "gi|33334157|gb|AF547987.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 27184}, {"hit_start": 90, "description": "Genes cro cII and oop of the lambdoid phage 434", "ID": "gi|14988|emb|V00635.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 120}, {"hit_start": 689, "description": "Cloning vector lambda gt10, region flanking the cloning site", "ID": "gi|1805220|gb|U02447.1|CVU02447", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 719}, {"hit_start": 90, "description": "Cloning vector pBRcro434", "ID": "gi|341885|gb|M28306.1|SYNCRO434P", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 120}, {"hit_start": 61, "description": "Bacteriophage 434 right operator", "ID": "gi|312218|emb|X73093.1|", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 91}, {"hit_start": 27, "description": "Bacteriophage 434 operator region DNA with recognition sites for repressor and cro proteins", "ID": "gi|215350|gb|M12803.1|P434OPRA", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 57}, {"hit_start": 90, "description": "bacteriophage lambda imm434 ecori-g fragment", "ID": "gi|215173|gb|J02460.1|LAMIMM434", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 120}, {"hit_start": 709, "description": "Bacteriophage 434 cI gene inserted in plasmid pNS1", "ID": "gi|207772|gb|M12904.1|SYN322CI", "query_end": 30, "query_start": 0, "evalue": 8.1e-06, "score": 55.39, "span": 30, "hit_end": 739}, {"hit_start": 28271, "description": "Enterobacteria phage HK446, complete genome", "ID": "gi|383395188|gb|JQ086372.1|", "query_end": 30, "query_start": 2, "evalue": 9.9e-05, "score": 51.78, "span": 28, "hit_end": 28299}, {"hit_start": 3270693, "description": "Escherichia coli strain 2013C-4465, complete genome", "ID": "gi|1028480521|gb|CP015241.1|", "query_end": 30, "query_start": 0, "evalue": 0.00035, "score": 49.98, "span": 30, "hit_end": 3270723}, {"hit_start": 2071903, "description": "Escherichia albertii DNA, complete genome, strain: CB9786", "ID": "gi|949425325|dbj|AP014856.1|", "query_end": 30, "query_start": 0, "evalue": 0.00035, "score": 49.98, "span": 30, "hit_end": 2071933}, {"hit_start": 3456, "description": "Escherichia coli genome assembly FHI34, scaffold scaffold-23_contig-2.1_247893_715567_[organism:Escherichia", "ID": "gi|675819931|emb|LM996494.1|", "query_end": 30, "query_start": 0, "evalue": 0.00035, "score": 49.98, "span": 30, "hit_end": 3486}, {"hit_start": 983527, "description": "Escherichia coli O55:H7 str. RM12579, complete genome", "ID": "gi|374356928|gb|CP003109.1|", "query_end": 30, "query_start": 0, "evalue": 0.00035, "score": 49.98, "span": 30, "hit_end": 983557}, {"hit_start": 311822, "description": "Escherichia coli O55:H7 str. CB9615, complete genome", "ID": "gi|290760697|gb|CP001846.1|", "query_end": 30, "query_start": 0, "evalue": 0.00035, "score": 49.98, "span": 30, "hit_end": 311852}, {"hit_start": 293, "description": "Schistosoma curassoni genome assembly S_curassoni_Dakar ,scaffold SCUD_scaffold0024139", "ID": "gi|689633253|emb|LM107108.1|", "query_end": 29, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 31, "hit_end": 324}, {"hit_start": 889, "description": "Schistosoma curassoni genome assembly S_curassoni_Dakar ,scaffold SCUD_contig0007244", "ID": "gi|689616655|emb|LM089551.1|", "query_end": 29, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 31, "hit_end": 920}, {"hit_start": 2639, "description": "Schistosoma curassoni genome assembly S_curassoni_Dakar ,scaffold SCUD_contig0003316", "ID": "gi|689601181|emb|LM079868.1|", "query_end": 29, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 31, "hit_end": 2670}, {"hit_start": 27968, "description": "Schistosoma curassoni genome assembly S_curassoni_Dakar ,scaffold SCUD_scaffold0000115", "ID": "gi|689591657|emb|LM065156.1|", "query_end": 29, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 31, "hit_end": 27999}, {"hit_start": 51501, "description": "Schistosoma margrebowiei genome assembly S_margrebowiei_Zambia ,scaffold SMRZ_scaffold0000799", "ID": "gi|689399947|emb|LL877976.1|", "query_end": 29, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 31, "hit_end": 51532}, {"hit_start": 73395, "description": "Schistosoma margrebowiei genome assembly S_margrebowiei_Zambia ,scaffold SMRZ_scaffold0000475", "ID": "gi|689399381|emb|LL877464.1|", "query_end": 29, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 31, "hit_end": 73426}, {"hit_start": 4136, "description": "Schistosoma margrebowiei genome assembly S_margrebowiei_Zambia ,scaffold SMRZ_scaffold0000428", "ID": "gi|689399308|emb|LL877391.1|", "query_end": 29, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 31, "hit_end": 4167}, {"hit_start": 1162830, "description": "Prochlorococcus marinus str. MIT 9515, complete genome", "ID": "gi|123199600|gb|CP000552.1|", "query_end": 27, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 27, "hit_end": 1162857}, {"hit_start": 473, "description": "Prochlorococcus marinus str. MIT 9515 photosystem D2 protein (psbD) gene, partial cds", "ID": "gi|95115429|gb|DQ473689.1|", "query_end": 27, "query_start": 0, "evalue": 0.18, "score": 40.96, "span": 27, "hit_end": 500}, {"hit_start": 29808, "description": "Mouse DNA sequence from clone RP23-170L10 on chromosome 7, complete sequence", "ID": "gi|17017731|emb|AL513346.17|", "query_end": 28, "query_start": 1, "evalue": 0.18, "score": 40.96, "span": 27, "hit_end": 29835}, {"hit_start": 3025, "description": "PREDICTED: Oryza brachyantha uncharacterized LOC102712877 (LOC102712877), mRNA", "ID": "gi|1002839660|ref|XM_006646189.2|", "query_end": 30, "query_start": 4, "evalue": 0.63, "score": 39.16, "span": 26, "hit_end": 3051}, {"hit_start": 23073867, "description": "Oryza sativa Japonica Group DNA, chromosome 4, cultivar: Nipponbare, complete sequence", "ID": "gi|937912581|dbj|AP014960.1|", "query_end": 30, "query_start": 9, "evalue": 0.63, "score": 39.16, "span": 21, "hit_end": 23073888}], "success": true}')
        result = []
        for i in BLAST(request['seq'].upper()):
            l = str(i).split('\n')[-1].split()
            q = l[4].replace('[', '').replace(']', '').split(':')
            h = l[5].replace('[', '').replace(']', '').split(':')
            result.append(dict(ID=i.id, description=i.description, evalue=float(l[1]), score=float(l[2]),
                    span=int(l[3]), query_start=int(q[0]), query_end=int(q[1]), hit_start=int(h[0]), hit_end=int(h[1])))
        return dict(result=result)

__plugin__ = Blast()
